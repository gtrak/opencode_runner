# Codebase Structure

**Analysis Date:** 2026-02-05

## Directory Layout

```
opencode_runner/
├── .git/                     # Git repository
├── .opencode/                # GSD agent configuration
├── .planning/                # Planning artifacts
│   └── codebase/             # Architecture analysis documents
├── src/                      # Source code directory
│   ├── client.rs             # OpenCode client wrapper
│   ├── control_loop.rs       # Core orchestration logic
│   ├── main.rs               # CLI entry point
│   ├── opencode_stub.rs      # Platform SDK stub for Windows
│   ├── reviewer.rs           # External API review client
│   ├── sampler.rs            # Output sampling buffer
│   ├── server.rs             # OpenCode server lifecycle
│   ├── state.rs              # State tracking
│   └── tui/
│       └── mod.rs            # Terminal UI implementation
├── target/                   # Rust build artifacts
├── Cargo.lock                # Dependency lockfile
├── Cargo.toml                # Rust project manifest
├── plan.md                   # Implementation plan document
└── .gitignore                # Git ignore rules
```

## Directory Purposes

**src/:**
- Purpose: All Rust source code
- Contains: Module files for client, control loop, server, sampler, state, TUI
- Key files: `main.rs`, `control_loop.rs`, `sampler.rs`, `server.rs`

**src/tui/:**
- Purpose: Terminal UI implementation module
- Contains: Single `mod.rs` file with UI rendering and event handling
- Key files: `src/tui/mod.rs`

**.opencode/:**
- Purpose: GSD agent and workflow configuration
- Contains: Agent definitions, templates, and hooks
- Not part of compiled output

**target/:**
- Purpose: Rust compilation output (target directory)
- Contains: Compiled binaries, object files, test artifacts
- Not committed (in `.gitignore`)

**.planning/:**
- Purpose: Planning and analysis artifacts
- Contains: Architecture documentation generated by GSD
- Not compiled into binary

**root/:**
- Purpose: Project root with metadata
- Contains: Cargo.toml, lockfile, Git repository, documentation

## Key File Locations

**Entry Points:**
- `src/main.rs`: Application entry point with CLI parsing and orchestration

**Configuration:**
- `Cargo.toml`: Rust project manifest with dependencies and features
- `Cargo.lock`: Dependency version locking
- `plan.md`: Implementation plan and architecture overview

**Core Logic:**
- `src/control_loop.rs`: Main control loop orchestrating iterations
- `src/sampler.rs`: Event buffering and sampling logic
- `src/reviewer.rs`: External API review client with retry logic
- `src/server.rs`: External process lifecycle management
- `src/client.rs`: OpenCode SDK communication wrapper

**State & UI:**
- `src/state.rs`: Iteration history and summary generation
- `src/tui/mod.rs`: Terminal UI with event handling and rendering

**Platform Support:**
- `src/opencode_stub.rs`: Windows platform stub for OpenCode SDK

**Documentation:**
- `plan.md`: High-level implementation plan and architecture diagram

## Naming Conventions

**Files:**
- **snake_case.rs**: All Rust modules use lowercase with underscores (e.g., `control_loop.rs`, `sampler.rs`)
- **module names**: Module names match filename (e.g., `mod client;` imports `client.rs`)
- **feature-gated modules**: Platform-specific modules prefixed with `opencode_stub` or gated by `#[cfg]`

**Directories:**
- **Lowercase with underscores**: `src/tui/` (not `src/TUI/` or `src/tui_module/`)
- **Single-level subdirectories**: No nested module subdirectories

**Variables:**
- **camelCase**: Function parameters and local variables (e.g., `event_sender`, `base_url`)
- **PascalCase**: Struct names and public functions (e.g., `ControlLoop`, `ServerManager`)
- **SCREAMING_SNAKE_CASE**: Constants and configuration (though few constants used)
- **camelCase with mut**: Mutable variables (e.g., `mut control_loop`, `mut state`)

**Types:**
- **PascalCase**: Structs, enums, and traits (e.g., `ControlLoop`, `ReviewerDecision`, `RunResult`)
- **SCREAMING_SNAKE_CASE**: Enum variants (e.g., `Continue`, `Abort`, `MaxIterations`)
- **lowerCamelCase**: Associated enum variants (e.g., `ReviewerAction::Continue`, `UiEvent::WorkerOutput`)

**Functions:**
- **camelCase**: Most functions (e.g., `run()`, `create_session()`, `sample()`)
- **PascalCase**: Constructors and public API methods (e.g., `new()`, `spawn()`, `review_with_retry()`)

**Modules:**
- **lowercase with underscores**: Module declarations (e.g., `mod client;`, `mod control_loop;`)
- **pub visibility**: Public modules exported for use in `main.rs`

## Where to Add New Code

**New Feature Logic:**
- Primary code: `src/[feature].rs` (e.g., `src/feedback.rs` for feedback system)
- Tests: Add tests in same file with `#[cfg(test)] mod tests {}` block at end
- Import in `main.rs` as `mod [feature];`

**New Component/Module:**
- Implementation: Create new `src/[feature].rs` file with camelCase module name
- Export from module if public-facing
- Import via `mod [feature];` in `main.rs` or parent module

**Utilities:**
- Shared helpers: Create `src/utils.rs` or add to existing utility module
- Keep small, reusable functions
- Use `pub` for public utility functions

**TUI Enhancements:**
- New widgets: Add to `src/tui/mod.rs` in `draw_*()` or `ui_*()` functions
- New events: Add to `UiEvent` enum in `control_loop.rs`
- New state fields: Update `UiState` struct in `src/tui/mod.rs`

**Platform-Specific Features:**
- Unix-only: Add `#[cfg(unix)]` guards with SDK code
- Windows-only: Add `#[cfg(windows)]` guards with stub code
- Keep platform code separate to avoid Windows build errors

**Integration Tests:**
- Location: No dedicated tests directory (tests co-located in source files)
- Format: `#[cfg(test)] mod tests { ... }` at end of each source file
- Run with: `cargo test`

**Configuration:**
- CLI arguments: Add fields to `Args` struct in `main.rs`
- Cargo.toml: Add dependencies under `[dependencies]` or `[features]`

## Special Directories

**.opencode/:**
- Purpose: GSD agent configuration and templates
- Generated: No
- Committed: Yes (agent workflow definitions)
- Contains: `agents/`, `get-shit-done/`, `hooks/`, `templates/`

**.planning/:**
- Purpose: Architecture and analysis documents
- Generated: Yes (created by GSD mapping commands)
- Committed: Yes (archived documentation)
- Contains: `codebase/`, `workflows/`, `issues/`

**src/tui/:**
- Purpose: Terminal UI module directory
- Generated: No
- Committed: Yes
- Contains: Single `mod.rs` file for TUI logic

**target/:**
- Purpose: Rust build artifacts
- Generated: Yes (compiled by cargo)
- Committed: No (in `.gitignore`)
- Contents: Binaries, object files, test results

**.git/:**
- Purpose: Git version control
- Generated: No
- Committed: Yes (repository data)
- Contents: Branches, commits, blobs

---

*Structure analysis: 2026-02-05*
