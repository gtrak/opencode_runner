---
phase: 01-specification-audit
plan: 03
type: execute
wave: 1
depends_on: []
files_modified: []
autonomous: true

must_haves:
  truths:
    - "All 9 Reviewer requirements (REV-01 to REV-09) from plan.md are verified against reviewer.rs"
    - "All 6 State requirements (STA-01 to STA-06) from plan.md are verified against state.rs"
    - "Reviewer implements exponential backoff retry with 3 retries"
    - "State tracks iteration history with ReviewerDecision records"
    - "Prompt template matches spec exactly"
  artifacts:
    - path: ".planning/phases/01-specification-audit/01-03-SUMMARY.md"
      provides: "Reviewer and State audit findings"
      contains: "Requirement verification table with retry logic validation"
  key_links:
    - from: "plan.md Reviewer prompt template"
      to: "src/reviewer.rs build_prompt"
      pattern: "You are monitoring an AI assistant"
    - from: "plan.md Reviewer retry logic"
      to: "src/reviewer.rs review_with_retry"
      pattern: "2u64.pow(attempt as u32)"
---

<objective>
Audit Reviewer Client (reviewer.rs) and State Management (state.rs) against plan.md specification.

Purpose: Verify that the OpenAI-compatible reviewer API integration and state tracking match specification requirements.

Output: Audit report documenting requirements verification for Reviewer and State components.
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
</execution_context>

<context>
@./plan.md
@./src/reviewer.rs
@./src/state.rs

## Reviewer Requirements to Verify (9 total)

**REV-01:** `ReviewerClient` struct with http_client, base_url, model, max_retries
**REV-02:** `ReviewerDecision` struct with action and reason fields
**REV-03:** `ReviewerAction` enum with Continue and Abort variants
**REV-04:** `new(base_url, model)` constructor
**REV-05:** `review_with_retry()` with exponential backoff (3 retries)
**REV-06:** Retry delay: 2^attempt seconds (1s, 2s, 4s)
**REV-07:** Default to Continue after max retries
**REV-08:** Prompt template matches spec exactly
**REV-09:** OpenAI-compatible API request format

## State Requirements to Verify (6 total)

**STA-01:** `State` struct with iterations, current_iteration, start_time
**STA-02:** `Iteration` struct with number, timestamp, sample_size, decision, retry_count
**STA-03:** `new()` - Create new state tracker
**STA-04:** `start_iteration()` - Increment counter
**STA-05:** `record_decision()` - Store iteration result
**STA-06:** `get_previous_summaries()` - Get history for reviewer context

## Retry Logic from Spec

```rust
for attempt in 0..self.max_retries {
    match self.review(context).await {
        Ok(decision) => return Ok(decision),
        Err(e) => {
            let delay = Duration::from_secs(2u64.pow(attempt as u32));
            // retry after delay
        }
    }
}
// Default to Continue after max retries
```

## Prompt Template from Spec

```
You are monitoring an AI assistant's progress on a task.

Task: {task_description}

Current iteration: {iteration}

Previous progress assessments:
{previous_summaries}

Current output (last {N} lines):
```
{current_sample}
```

Assess whether the assistant is:
1. Making meaningful progress (continue)
2. Stuck in a loop or not progressing (abort)

Respond with JSON:
{
  "action": "continue|abort",
  "reason": "Brief explanation"
}
```
</context>

<tasks>

<task type="auto">
  <name>Task 1: Audit Reviewer Implementation</name>
  <files>src/reviewer.rs</files>
  <action>
Compare the ReviewerClient implementation in src/reviewer.rs against the 9 REV requirements from plan.md.

Check each requirement:
- REV-01: Verify struct has http_client, base_url, model, max_retries fields
- REV-02: Verify ReviewerDecision has action: ReviewerAction, reason: String
- REV-03: Verify ReviewerAction enum has Continue and Abort with #[serde(rename_all = "lowercase")]
- REV-04: Verify new() creates HTTP client with 30s timeout
- REV-05: Verify review_with_retry() attempts up to max_retries (3)
- REV-06: Verify delay calculation uses 2u64.pow(attempt as u32) for exponential backoff
- REV-07: Verify returns Continue decision after max retries with warning log
- REV-08: Verify build_prompt() output matches spec template exactly
- REV-09: Verify ChatRequest uses OpenAI-compatible format with response_format

Validate implementation details:
- API endpoint: {base_url}/chat/completions
- Model field passed correctly
- JSON response parsing
- Error handling with context
- Logging at appropriate levels

Check spec deviations:
- Does prompt template match exactly?
- Are all JSON fields correct?
- Is retry count configurable or hardcoded?
  </action>
  <verify>Review src/reviewer.rs lines 37-265 to confirm all structures and retry logic match spec</verify>
  <done>All 9 Reviewer requirements verified, retry logic and prompt template validated</done>
</task>

<task type="auto">
  <name>Task 2: Audit State Management Implementation</name>
  <files>src/state.rs</files>
  <action>
Compare the State implementation in src/state.rs against the 6 STA requirements from plan.md.

Check each requirement:
- STA-01: Verify State has iterations: Vec<Iteration>, current_iteration: usize, start_time: DateTime<Utc>
- STA-02: Verify Iteration has all fields: number, timestamp, sample_size, decision, reviewer_retry_count
- STA-03: Verify new() initializes with empty iterations, current_iteration=0, Utc::now() start
- STA-04: Verify start_iteration() increments current_iteration
- STA-05: Verify record_decision() creates Iteration and pushes to iterations vector
- STA-06: Verify get_previous_summaries() returns formatted strings for reviewer context

Validate additional implementation:
- is_max_iterations() correctly compares current_iteration >= max
- format_activity_log() produces readable output
- status_summary() provides current state
- Helper methods: runtime(), last_iteration(), total_lines_sampled(), total_retries()
- Uses chrono for timestamps
- ReviewerAction imported from reviewer module

Check for consistency:
- Field names match spec (reviewer_retry_count vs retry_count)
- Iteration number is 1-indexed in output
- Summaries are reversed and re-reversed correctly
  </action>
  <verify>Review src/state.rs lines 5-167 to confirm all State methods match spec</verify>
  <done>All 6 State requirements verified</done>
</task>

<task type="auto">
  <name>Task 3: Document Audit Findings</name>
  <files>.planning/phases/01-specification-audit/01-03-SUMMARY.md</files>
  <action>
Create 01-03-SUMMARY.md with structured audit findings:

```markdown
# Reviewer and State Audit Summary

## Overview
- Component: Reviewer Client (reviewer.rs) + State (state.rs)
- Requirements: 9 REV + 6 STA = 15 total
- Status: [X/15] requirements fully met

## Reviewer Requirements Verification

| ID | Requirement | Status | Location | Notes |
|----|-------------|--------|----------|-------|
| REV-01 | ReviewerClient struct fields | ✓/✗ | src/reviewer.rs:38 | |
| REV-05 | review_with_retry() | ✓/✗ | src/reviewer.rs:101 | |
| REV-06 | Exponential backoff | ✓/✗ | src/reviewer.rs:114 | Verify 2^attempt |
| REV-08 | Prompt template | ✓/✗ | src/reviewer.rs:211 | Compare to spec |
| ... | ... | | | |

## State Requirements Verification

| ID | Requirement | Status | Location | Notes |
|----|-------------|--------|----------|-------|
| STA-01 | State struct | ✓/✗ | src/state.rs:5 | |
| ... | ... | | | |

## Retry Logic Validation

| Aspect | Spec | Implementation | Match? |
|--------|------|----------------|--------|
| Max retries | 3 | src/reviewer.rs:95 | ✓/✗ |
| Delay formula | 2^attempt seconds | src/reviewer.rs:114 | ✓/✗ |
| Default action | Continue | src/reviewer.rs:127 | ✓/✗ |

## Prompt Template Validation

Compare build_prompt() output to spec template:
- Opening line match? 
- Task field included?
- Iteration number included?
- Previous summaries section?
- Current output formatting?
- Instructions match?
- JSON format correct?

## Deviations from Specification

1. **[File:Line]** - Description of deviation

## Missing Features

1. **[Requirement ID]** - Description of what's missing

## Recommendations

1. Priority fixes needed
```

Include specific code snippets comparing spec to implementation where deviations exist.
  </action>
  <verify>Verify SUMMARY.md exists with retry logic and prompt template validation sections</verify>
  <done>Audit summary written with complete findings</done>
</task>

</tasks>

<verification>
- All 9 Reviewer requirements checked against src/reviewer.rs
- All 6 State requirements checked against src/state.rs
- Exponential backoff formula validated (2^attempt)
- Prompt template compared to spec
- API request format validated as OpenAI-compatible
- Verification tables include file:line references
</verification>

<success_criteria>
- [ ] REV-01 through REV-09 verified against reviewer.rs
- [ ] STA-01 through STA-06 verified against state.rs
- [ ] Retry logic uses 2u64.pow(attempt) for exponential backoff
- [ ] Prompt template matches spec (compare line-by-line)
- [ ] Any deviations documented with file:line references
- [ ] 01-03-SUMMARY.md created with complete audit findings
</success_criteria>

<output>
After completion, create `.planning/phases/01-specification-audit/01-03-SUMMARY.md` containing the audit findings.
</output>
