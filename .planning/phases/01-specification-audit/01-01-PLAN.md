---
phase: 01-specification-audit
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: []
autonomous: true

must_haves:
  truths:
    - "All 13 CLI requirements (CLI-01 to CLI-13) from plan.md are verified against main.rs"
    - "All 7 Server requirements (SRV-01 to SRV-07) from plan.md are verified against server.rs"
    - "Every CLI argument from spec exists with correct type and default"
    - "Server manager implements all interface methods from spec"
    - "Deviations, gaps, and missing features are documented with file:line references"
  artifacts:
    - path: ".planning/phases/01-specification-audit/01-01-SUMMARY.md"
      provides: "CLI and Server audit findings"
      contains: "Requirement verification table with status"
  key_links:
    - from: "plan.md CLI section"
      to: "src/main.rs Args struct"
      pattern: "#[derive(Parser)]"
    - from: "plan.md Server section"
      to: "src/server.rs ServerManager"
      pattern: "impl ServerManager"
---

<objective>
Audit CLI (main.rs) and Server Management (server.rs) against plan.md specification.

Purpose: Verify that command-line interface and server lifecycle management match the specification requirements before proceeding to integration testing.

Output: Audit report documenting which requirements are met, which have deviations, and any missing features.
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
</execution_context>

<context>
@./plan.md
@./src/main.rs
@./src/server.rs

## CLI Requirements to Verify (13 total)

**CLI-01:** Binary name `opencode_runner` with description "Control loop for OpenCode agent execution with review"
**CLI-02:** `--task` / `-t` (required) - Task description for the worker  
**CLI-03:** `--working-dir` / `-w` (default: ".") - Working directory for the task
**CLI-04:** `--worker-model` (default: "ollama/llama3.1") - Model for the worker
**CLI-05:** `--reviewer-url` (default: "http://localhost:11434/v1") - OpenAI-compatible API URL
**CLI-06:** `--reviewer-model` (default: "ollama/llama3.1") - Model for the reviewer
**CLI-07:** `--max-iterations` (default: 10) - Maximum iterations before forcing abort
**CLI-08:** `--inactivity-timeout` (default: 30) - Inactivity timeout in seconds
**CLI-09:** `--headless` (flag) - Run without TUI
**CLI-10:** Trailing var arg support for extra opencode serve arguments
**CLI-11:** Parse and validate all arguments
**CLI-12:** Initialize logging/tracing
**CLI-13:** Handle shutdown signals

## Server Requirements to Verify (7 total)

**SRV-01:** `ServerManager` struct exists with `process`, `port`, `base_url` fields
**SRV-02:** `spawn()` method with working_dir, model, extra_args parameters
**SRV-03:** Use `portpicker` to find available port
**SRV-04:** Spawn: `opencode serve --port {port} --hostname 127.0.0.1 --model {model} {extra_args...}`
**SRV-05:** Set working directory with `current_dir()`
**SRV-06:** Implement graceful shutdown
**SRV-07:** Implement `Drop` for cleanup
</context>

<tasks>

<task type="auto">
  <name>Task 1: Audit CLI Implementation Against Requirements</name>
  <files>src/main.rs</files>
  <action>
Compare the Args struct in src/main.rs against the 13 CLI requirements from plan.md. Create a verification table with columns: Requirement ID, Specification, Implementation Status, Notes/Deviations.

Check each requirement:
- CLI-01: Verify #[command(name = "opencode_runner")] and about text
- CLI-02 to CLI-09: Verify each argument exists with correct short/long names, types, and default values
- CLI-10: Verify trailing_var_arg and allow_hyphen_values on extra_args
- CLI-11: Verify Args::parse() is called and errors propagate correctly
- CLI-12: Verify tracing_subscriber initialization
- CLI-13: Check if shutdown signal handling exists (SIGINT/SIGTERM)

Document any deviations, missing features, or implementation gaps with specific file:line references.
  </action>
  <verify>Review src/main.rs lines 26-65 to confirm all Args fields match spec requirements</verify>
  <done>All 13 CLI requirements verified and documented in findings table</done>
</task>

<task type="auto">
  <name>Task 2: Audit Server Management Implementation</name>
  <files>src/server.rs</files>
  <action>
Compare the ServerManager implementation in src/server.rs against the 7 SRV requirements from plan.md.

Check each requirement:
- SRV-01: Verify struct has process: Child, port: u16, base_url: String
- SRV-02: Verify spawn() signature matches: working_dir: &Path, model: &str, extra_args: &[String]
- SRV-03: Verify portpicker::pick_unused_port() is used
- SRV-04: Verify command construction matches: opencode serve --port {port} --hostname 127.0.0.1 --model {model}
- SRV-05: Verify .current_dir(working_dir) is called
- SRV-06: Verify shutdown() method exists and attempts graceful termination
- SRV-07: Verify Drop impl exists for cleanup

Also check implementation details from spec:
- Health check at {base_url}/health with timeout
- Process status verification after spawn
- Error handling with anyhow context

Document deviations, missing features, or gaps with file:line references.
  </action>
  <verify>Review src/server.rs lines 8-169 to confirm all ServerManager methods match spec</verify>
  <done>All 7 Server requirements verified and documented in findings table</done>
</task>

<task type="auto">
  <name>Task 3: Document Audit Findings</name>
  <files>.planning/phases/01-specification-audit/01-01-SUMMARY.md</files>
  <action>
Create 01-01-SUMMARY.md with structured audit findings:

```markdown
# CLI and Server Audit Summary

## Overview
- Component: CLI (main.rs) + Server Manager (server.rs)
- Requirements: 13 CLI + 7 SRV = 20 total
- Status: [X/20] requirements fully met

## CLI Requirements Verification

| ID | Requirement | Status | Location | Notes |
|----|-------------|--------|----------|-------|
| CLI-01 | Binary name and description | ✓/✗ | src/main.rs:27 | |
| ... | ... | | | |

## Server Requirements Verification

| ID | Requirement | Status | Location | Notes |
|----|-------------|--------|----------|-------|
| SRV-01 | ServerManager struct fields | ✓/✗ | src/server.rs:8 | |
| ... | ... | | | |

## Deviations from Specification

1. **[File:Line]** - Description of deviation and impact

## Missing Features

1. **[Requirement ID]** - Description of what's missing

## Recommendations

1. Priority fixes needed before proceeding
```

Be specific and actionable. Every finding must include file:line reference.
  </action>
  <verify>Verify SUMMARY.md exists with complete verification table and specific file:line references</verify>
  <done>Audit summary written with all findings documented</done>
</task>

</tasks>

<verification>
- All 13 CLI requirements checked against src/main.rs
- All 7 Server requirements checked against src/server.rs
- Verification table includes file:line references for each item
- Deviations and gaps clearly documented
- SUMMARY.md written to phase directory
</verification>

<success_criteria>
- [ ] CLI-01 through CLI-13 verified against main.rs
- [ ] SRV-01 through SRV-07 verified against server.rs
- [ ] Verification table shows status (✓/✗) for each requirement
- [ ] Any deviations documented with specific file:line references
- [ ] 01-01-SUMMARY.md created with complete audit findings
</success_criteria>

<output>
After completion, create `.planning/phases/01-specification-audit/01-01-SUMMARY.md` containing the audit findings.
</output>
