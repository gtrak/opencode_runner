---
phase: 01-specification-audit
plan: 02
type: execute
wave: 1
depends_on: []
files_modified: []
autonomous: true

must_haves:
  truths:
    - "All 6 Client requirements (CLT-01 to CLT-06) from plan.md are verified against client.rs"
    - "All 10 Sampler requirements (SMP-01 to SMP-10) from plan.md are verified against sampler.rs"
    - "OpenCodeClient implements all interface methods from spec"
    - "Sampler implements 100-line ring buffer with correct event filtering"
    - "Event filtering rules match spec table exactly"
  artifacts:
    - path: ".planning/phases/01-specification-audit/01-02-SUMMARY.md"
      provides: "Client and Sampler audit findings"
      contains: "Requirement verification table with event filtering validation"
  key_links:
    - from: "plan.md Client section"
      to: "src/client.rs OpenCodeClient"
      pattern: "impl OpenCodeClient"
    - from: "plan.md Sampler event table"
      to: "src/sampler.rs process_event"
      pattern: "match event"
---

<objective>
Audit OpenCode Client (client.rs) and Sampler (sampler.rs) against plan.md specification.

Purpose: Verify that the OpenCode SDK wrapper and output sampling/buffering match the specification requirements.

Output: Audit report documenting requirements verification for Client and Sampler components.
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
</execution_context>

<context>
@./plan.md
@./src/client.rs
@./src/sampler.rs

## Client Requirements to Verify (6 total)

**CLT-01:** `OpenCodeClient` struct exists with `inner: opencode_rs::Client` and `session_id: String`
**CLT-02:** `connect(base_url: &str)` - Create client and connect to server
**CLT-03:** `create_session(task: &str)` - Create new session with initial task
**CLT-04:** `subscribe(session_id: &str)` - Subscribe to session events (SSE stream)
**CLT-05:** `send_message(session_id: &str, text: &str)` - Send message to session
**CLT-06:** Use `Client::builder()` with server URL, handle auth from env vars

## Sampler Requirements to Verify (10 total)

**SMP-01:** `Sampler` struct exists with `buffer: VecDeque<String>` and `max_lines: usize`
**SMP-02:** `new(max_lines: usize)` - Create sampler with specified capacity
**SMP-03:** `process_event(&mut self, event: &Event)` - Process SSE events
**SMP-04:** `sample(&self) -> String` - Get current sample (last N lines)
**SMP-05:** `clear(&mut self)` - Clear the buffer
**SMP-06:** Fixed 100-line ring buffer (max_lines = 100)
**SMP-07:** Event filtering per spec table (PartAdded text, PartUpdated, ToolCall)
**SMP-08:** Skip ToolResult (too verbose)
**SMP-09:** Skip Thinking/Reasoning content
**SMP-10:** Skip System messages, capture Error events

## Event Filtering Rules from Spec

| Event Type | Capture? | Notes |
|------------|----------|-------|
| PartAdded (text) | Yes | Main content |
| PartUpdated | Yes | Content updates |
| ToolCall | Yes | Invocation only: `[Tool: name(params)]` |
| ToolResult | No | Too verbose, skip outputs |
| Thinking/Reasoning | No | Skip internal reasoning |
| System messages | No | Skip system events |
| Error events | Yes | Error messages |
</context>

<tasks>

<task type="auto">
  <name>Task 1: Audit OpenCode Client Implementation</name>
  <files>src/client.rs</files>
  <action>
Compare the OpenCodeClient implementation in src/client.rs against the 6 CLT requirements from plan.md.

Check each requirement:
- CLT-01: Verify struct has inner field (OpencodeClient type) - note: spec mentions session_id but implementation may differ
- CLT-02: Verify connect() method exists, uses Client::builder(), verifies health
- CLT-03: Verify create_session() creates session and sends initial prompt via prompt_async
- CLT-04: Verify subscribe() method exists and returns SseSubscription
- CLT-05: Verify send_message() method exists (for future feedback)
- CLT-06: Verify uses Client::builder() with base_url, check if auth handling exists

Also verify:
- Platform-specific imports (Unix vs Windows)
- Helper functions extract_event_text and extract_tool_call
- Error handling with anyhow context

Document deviations, missing session_id field if not present, and any gaps.
  </action>
  <verify>Review src/client.rs lines 27-155 to confirm all interface methods match spec</verify>
  <done>All 6 Client requirements verified and documented</done>
</task>

<task type="auto">
  <name>Task 2: Audit Sampler Implementation and Event Filtering</name>
  <files>src/sampler.rs</files>
  <action>
Compare the Sampler implementation in src/sampler.rs against the 10 SMP requirements from plan.md.

Check each requirement:
- SMP-01: Verify struct has buffer: VecDeque<String>, max_lines: usize
- SMP-02: Verify new() creates with specified max_lines
- SMP-03: Verify process_event() handles all event types
- SMP-04: Verify sample() returns concatenated buffer content
- SMP-05: Verify clear() empties the buffer
- SMP-06: Check main.rs confirms 100-line buffer is used (Sampler::new(100))
- SMP-07: Verify PartAdded(text), PartUpdated, ToolCall events are captured
- SMP-08: Verify ToolResult events are skipped (trace log only)
- SMP-09: Verify Thinking events are skipped (trace log only)
- SMP-10: Verify Error events are captured, System/Progress skipped

Validate event filtering matches spec table exactly:
- PartAdded text: captured via extract_text_content
- PartUpdated: captured (delta string)
- ToolCall: captured as "[Tool: name(params)]"
- ToolResult: skipped with trace log
- Thinking: skipped with trace log
- Progress: skipped with trace log
- Error: captured with "[Error: {}]" format

Check implementation details:
- Ring buffer behavior (pop_front when at capacity)
- Empty line filtering
- Line trimming

Document any deviations from the event filtering table.
  </action>
  <verify>Review src/sampler.rs lines 10-136 to confirm event filtering matches spec table</verify>
  <done>All 10 Sampler requirements verified, event filtering validated against spec table</done>
</task>

<task type="auto">
  <name>Task 3: Document Audit Findings</name>
  <files>.planning/phases/01-specification-audit/01-02-SUMMARY.md</files>
  <action>
Create 01-02-SUMMARY.md with structured audit findings:

```markdown
# Client and Sampler Audit Summary

## Overview
- Component: OpenCode Client (client.rs) + Sampler (sampler.rs)
- Requirements: 6 CLT + 10 SMP = 16 total
- Status: [X/16] requirements fully met

## Client Requirements Verification

| ID | Requirement | Status | Location | Notes |
|----|-------------|--------|----------|-------|
| CLT-01 | OpenCodeClient struct | ✓/✗ | src/client.rs:27 | Check session_id field |
| CLT-02 | connect() method | ✓/✗ | src/client.rs:33 | |
| ... | ... | | | |

## Sampler Requirements Verification

| ID | Requirement | Status | Location | Notes |
|----|-------------|--------|----------|-------|
| SMP-01 | Sampler struct | ✓/✗ | src/sampler.rs:12 | |
| SMP-02 | new() constructor | ✓/✗ | src/client.rs:19 | |
| ... | ... | | | |

## Event Filtering Validation

| Event Type | Spec Says | Implementation | Match? |
|------------|-----------|----------------|--------|
| PartAdded (text) | Capture | src/sampler.rs:31 | ✓/✗ |
| ToolResult | Skip | src/sampler.rs:53 | ✓/✗ |
| ... | ... | ... | ... |

## Deviations from Specification

1. **[File:Line]** - Description of deviation

## Missing Features

1. **[Requirement ID]** - Description of what's missing

## Recommendations

1. Priority fixes needed
```

Ensure event filtering table specifically validates against plan.md's filtering rules table.
  </action>
  <verify>Verify SUMMARY.md exists with event filtering validation table</verify>
  <done>Audit summary written with complete findings</done>
</task>

</tasks>

<verification>
- All 6 Client requirements checked against src/client.rs
- All 10 Sampler requirements checked against src/sampler.rs
- Event filtering rules validated against spec table
- Verification tables include file:line references
- Deviations and gaps documented
</verification>

<success_criteria>
- [ ] CLT-01 through CLT-06 verified against client.rs
- [ ] SMP-01 through SMP-10 verified against sampler.rs
- [ ] Event filtering table matches spec exactly
- [ ] Any deviations documented with file:line references
- [ ] 01-02-SUMMARY.md created with complete audit findings
</success_criteria>

<output>
After completion, create `.planning/phases/01-specification-audit/01-02-SUMMARY.md` containing the audit findings.
</output>
