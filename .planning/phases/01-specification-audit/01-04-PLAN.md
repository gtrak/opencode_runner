---
phase: 01-specification-audit
plan: 04
type: execute
wave: 1
depends_on: []
files_modified: []
autonomous: true

must_haves:
  truths:
    - "All 12 Control Loop requirements (CTL-01 to CTL-12) from plan.md are verified against control_loop.rs"
    - "All 10 TUI requirements (TUI-01 to TUI-10) from plan.md are verified against tui/mod.rs"
    - "Control loop flow matches architecture diagram in plan.md"
    - "Event streaming logic implements inactivity timeout correctly"
    - "TUI layout matches specification diagram"
  artifacts:
    - path: ".planning/phases/01-specification-audit/01-04-SUMMARY.md"
      provides: "Control Loop and TUI audit findings"
      contains: "Requirement verification table with flow validation"
  key_links:
    - from: "plan.md Control Loop flow diagram"
      to: "src/control_loop.rs run() method"
      pattern: "async fn run"
    - from: "plan.md TUI layout diagram"
      to: "src/tui/mod.rs draw_ui"
      pattern: "Layout::default"
---

<objective>
Audit Control Loop (control_loop.rs) and TUI (tui/mod.rs) against plan.md specification.

Purpose: Verify that the main orchestration logic and user interface match the specification requirements.

Output: Audit report documenting requirements verification for Control Loop and TUI components.
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
</execution_context>

<context>
@./plan.md
@./src/control_loop.rs
@./src/tui/mod.rs

## Control Loop Requirements to Verify (12 total)

**CTL-01:** `ControlLoop` struct with client, reviewer, sampler, state, config
**CTL-02:** `ControlConfig` with task, max_iterations, inactivity_timeout
**CTL-03:** `RunResult` enum with Completed, Aborted, MaxIterations
**CTL-04:** `UiEvent` enum for TUI communication
**CTL-05:** `run()` method implementing main flow
**CTL-06:** Connect to server
**CTL-07:** Create session with task
**CTL-08:** Subscribe to events
**CTL-09:** Stream events with inactivity timeout
**CTL-10:** Sample output and call reviewer
**CTL-11:** Handle Continue/Abort/MaxIterations decisions
**CTL-12:** Cleanup and exit

## TUI Requirements to Verify (10 total)

**TUI-01:** Feature-gated compilation (tui feature)
**TUI-02:** `Tui` struct with terminal backend
**TUI-03:** `UiState` for shared state management
**TUI-04:** `new()` and `new_from_state()` constructors
**TUI-05:** `run()` event loop with draw/input handling
**TUI-06:** Layout: Header, Main (Worker Output + Activity Log), Footer
**TUI-07:** Worker output panel (scrolling, last 100 lines)
**TUI-08:** Activity log panel (reviewer decisions)
**TUI-09:** Status bar with iteration info
**TUI-10:** Keyboard handling (q, Ctrl+C, ESC to quit)

## Control Loop Flow from Spec

```
1. Connect to server
2. Create session with task
3. Subscribe to events
4. Initialize sampler
5. Start event loop:
   a. Stream events until:
      - Inactivity timeout (no events for N seconds)
      - Session completes (detected via event type)
   b. Sample output from buffer
   c. Call reviewer API (with retry)
   d. Record decision in state
   e. If Abort â†’ exit loop
   f. If Continue â†’ continue streaming
6. Cleanup and exit
```

## TUI Layout from Spec

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ðŸ–¥ï¸  OpenCode Runner    Iter: 3/10    Status: RUNNING    Uptime: 00:05:23   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                             â”‚                                                â”‚
â”‚  ðŸ’¬ Worker Output           â”‚  ðŸ“Š Activity Log                               â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€            â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                              â”‚
â”‚                             â”‚                                                â”‚
â”‚  > Initializing...          â”‚  â€¢ [00:01:12] Iter 1: Started task             â”‚
â”‚  > Analyzing requirements   â”‚  â€¢ [00:02:45] Iter 2: Progress detected        â”‚
â”‚  > Generating solution...   â”‚  â€¢ [00:04:30] Iter 3: Reviewing...             â”‚
â”‚                             â”‚                                                â”‚
â”‚  fn sort(arr: &mut [i32]) { â”‚  Last Review: 5s ago                           â”‚
â”‚      for i in 0..arr.len() {â”‚  Action: Continue                              â”‚
â”‚          for j in 0..arr    â”‚  Reason: Code generation in progress           â”‚
â”‚                             â”‚                                                â”‚
â”‚  [scrolling: last 100 lines]â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                 â”‚
â”‚                             â”‚  Reviewer: POST /v1/chat/completions           â”‚
â”‚                             â”‚  Model: llama3.1                               â”‚
â”‚                             â”‚                                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âš¡ Worker: ollama/llama3.1 @ http://127.0.0.1:54892    Press 'q' to quit      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
</context>

<tasks>

<task type="auto">
  <name>Task 1: Audit Control Loop Implementation</name>
  <files>src/control_loop.rs</files>
  <action>
Compare the ControlLoop implementation in src/control_loop.rs against the 12 CTL requirements from plan.md.

Check each requirement:
- CTL-01: Verify struct has all 5 fields: client, reviewer, sampler, state, config
- CTL-02: Verify ControlConfig has task: String, max_iterations: usize, inactivity_timeout: Duration
- CTL-03: Verify RunResult enum has Completed, Aborted(String), MaxIterations
- CTL-04: Verify UiEvent enum has WorkerOutput, ReviewerDecision, StatusUpdate
- CTL-05: Verify run() method exists and implements the flow from spec
- CTL-06: Verify connects to server (passed in via constructor)
- CTL-07: Verify create_session() is called with task from config
- CTL-08: Verify subscribe() is called to get SseSubscription
- CTL-09: Verify stream_until_review() implements inactivity timeout logic
- CTL-10: Verify sampler.sample() used and reviewer.review_with_retry() called
- CTL-11: Verify handles all three decision outcomes (Continue, Abort, MaxIterations)
- CTL-12: Verify cleanup happens (implicit in ownership/Drop)

Validate flow matches architecture:
- Check max iterations before each iteration
- Start iteration, stream events, get sample, review, record, decide
- Loop continues on Continue, exits on Abort or MaxIterations
- sampler.clear() called between iterations

Check event streaming logic:
- Uses tokio::time::timeout for periodic checks
- Tracks last_event_time for inactivity
- Returns Ok(()) on timeout or completion event
- is_completion_event() checks SessionCompleted and MessageCompleted

Document any flow differences from spec diagram.
  </action>
  <verify>Review src/control_loop.rs lines 49-302 to confirm flow matches architecture diagram</verify>
  <done>All 12 Control Loop requirements verified against flow diagram</done>
</task>

<task type="auto">
  <name>Task 2: Audit TUI Implementation</name>
  <files>src/tui/mod.rs</files>
  <action>
Compare the TUI implementation in src/tui/mod.rs against the 10 TUI requirements from plan.md.

Check each requirement:
- TUI-01: Verify feature-gated with #[cfg(feature = "tui")] in main.rs
- TUI-02: Verify Tui struct has terminal: Terminal<CrosstermBackend<Stdout>>
- TUI-03: Verify UiState has all fields: worker_output, activity_log, status, iteration, max_iterations, completed, final_result
- TUI-04: Verify new() and new_from_state() constructors exist
- TUI-05: Verify run() has event loop with draw and input handling
- TUI-06: Verify draw_ui() uses Layout with: Header (3), Main (split 60/40), Footer (3)
- TUI-07: Verify worker output panel shows last 100 lines with scrolling
- TUI-08: Verify activity log panel shows reviewer decisions with timestamps
- TUI-09: Verify header shows iteration counter (current/max) and status
- TUI-10: Verify keyboard handling for 'q', Ctrl+C, ESC

Validate layout structure:
- Vertical layout: Header | Main | Footer
- Main is horizontal split: Worker Output (60%) | Activity Log (40%)
- Header shows: "OpenCode Runner | Iteration X/Y | Status: ..."
- Footer shows quit instructions or completion message

Check drawing functions:
- draw_header(): iteration display, status styling
- draw_worker_output(): truncates long lines (>200 chars)
- draw_activity_log(): color codes (green=Continue, red=Abort)
- draw_footer(): shows completion state or quit hint

Check event processing:
- process_ui_event() handles WorkerOutput, ReviewerDecision, StatusUpdate
- Updates UiState appropriately
- Formats activity log entries with timestamps

Document any layout differences from spec diagram.
  </action>
  <verify>Review src/tui/mod.rs lines 24-346 to confirm layout matches spec diagram</verify>
  <done>All 10 TUI requirements verified against layout diagram</done>
</task>

<task type="auto">
  <name>Task 3: Document Audit Findings</name>
  <files>.planning/phases/01-specification-audit/01-04-SUMMARY.md</files>
  <action>
Create 01-04-SUMMARY.md with structured audit findings:

```markdown
# Control Loop and TUI Audit Summary

## Overview
- Component: Control Loop (control_loop.rs) + TUI (tui/mod.rs)
- Requirements: 12 CTL + 10 TUI = 22 total
- Status: [X/22] requirements fully met

## Control Loop Requirements Verification

| ID | Requirement | Status | Location | Notes |
|----|-------------|--------|----------|-------|
| CTL-01 | ControlLoop struct | âœ“/âœ— | src/control_loop.rs:50 | |
| CTL-05 | run() method | âœ“/âœ— | src/control_loop.rs:77 | |
| CTL-09 | Inactivity timeout | âœ“/âœ— | src/control_loop.rs:201 | Check duration logic |
| ... | ... | | | |

## TUI Requirements Verification

| ID | Requirement | Status | Location | Notes |
|----|-------------|--------|----------|-------|
| TUI-01 | Feature-gated | âœ“/âœ— | src/main.rs:16 | Check cfg(feature) |
| TUI-06 | Layout structure | âœ“/âœ— | src/tui/mod.rs:226 | Compare to diagram |
| TUI-10 | Keyboard handling | âœ“/âœ— | src/tui/mod.rs:156 | Check key codes |
| ... | ... | | | |

## Control Loop Flow Validation

Compare implementation to spec flow:

| Step | Spec | Implementation | Match? |
|------|------|----------------|--------|
| 1. Connect | Via constructor | src/control_loop.rs:50 | âœ“/âœ— |
| 2. Create session | create_session() | src/control_loop.rs:85 | âœ“/âœ— |
| 3. Subscribe | subscribe() | src/control_loop.rs:93 | âœ“/âœ— |
| 4. Stream events | stream_until_review() | src/control_loop.rs:125 | âœ“/âœ— |
| 5. Sample | sampler.sample() | src/control_loop.rs:136 | âœ“/âœ— |
| 6. Review | review_with_retry() | src/control_loop.rs:155 | âœ“/âœ— |
| 7. Record | record_decision() | src/control_loop.rs:164 | âœ“/âœ— |
| 8. Decide | match action | src/control_loop.rs:172 | âœ“/âœ— |

## TUI Layout Validation

Compare draw_ui() to spec diagram:

| Element | Spec | Implementation | Match? |
|---------|------|----------------|--------|
| Header | 3 lines, status | src/tui/mod.rs:253 | âœ“/âœ— |
| Worker Output | 60% width | src/tui/mod.rs:242 | âœ“/âœ— |
| Activity Log | 40% width | src/tui/mod.rs:242 | âœ“/âœ— |
| Footer | 3 lines, quit hint | src/tui/mod.rs:249 | âœ“/âœ— |

## Deviations from Specification

1. **[File:Line]** - Description of deviation

## Missing Features

1. **[Requirement ID]** - Description of what's missing

## Integration Concerns

Note any issues that could affect integration:
- Event channel buffer sizes
- TUI update frequency
- Timeout durations vs spec

## Recommendations

1. Priority fixes needed
```

Focus on flow and layout accuracy against the diagrams in plan.md.
  </action>
  <verify>Verify SUMMARY.md includes flow and layout validation tables</verify>
  <done>Audit summary written with complete findings</done>
</task>

</tasks>

<verification>
- All 12 Control Loop requirements checked against src/control_loop.rs
- All 10 TUI requirements checked against src/tui/mod.rs
- Flow matches architecture diagram from plan.md
- Layout matches TUI diagram from plan.md
- Inactivity timeout logic validated
- Event streaming logic validated
- Verification tables include file:line references
</verification>

<success_criteria>
- [ ] CTL-01 through CTL-12 verified against control_loop.rs
- [ ] TUI-01 through TUI-10 verified against tui/mod.rs
- [ ] Control flow matches architecture diagram
- [ ] TUI layout matches specification diagram
- [ ] Inactivity timeout correctly implemented
- [ ] Any deviations documented with file:line references
- [ ] 01-04-SUMMARY.md created with complete audit findings
</success_criteria>

<output>
After completion, create `.planning/phases/01-specification-audit/01-04-SUMMARY.md` containing the audit findings.
</output>
